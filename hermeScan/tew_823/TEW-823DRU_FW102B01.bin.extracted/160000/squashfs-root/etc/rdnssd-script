#!/bin/sh
RESOLV_IPV4="/var/etc/resolv.conf"
RESOLV_IPV6="/var/etc/resolv_ipv6.conf"
RESOLV_RDNSSD="/var/etc/resolv_rdnssd.conf"
RESOLV_DHCPV6="/var/etc/resolv_dhcpv6.conf"
RESOLV_CONF="/etc/resolv.conf"
SPECIFY_DNS=$(nvram get ipv6_wan_specify_dns)
WANPROTO=$(nvram get ipv6_wan_proto)
DNS_1=$(nvram get ${WANPROTO}_primary_dns)
DNS_2=$(nvram get ${WANPROTO}_secondary_dns)
PRE_DNS=$(cat $RESOLV_IPV6)

cat $RESOLV_DHCPV6 $RESOLV_RDNSSD > $RESOLV_IPV6
cat $RESOLV_IPV6 | grep "^search" | sed -e :x -e '$!N;s/\n/ /;tx' | sed 's/ search / /g' > "$RESOLV_IPV6.tmp"
DOMAIN=$(cat $RESOLV_IPV6.tmp)
TOTAL=0
COUNT=0
COUNT2=0
tmp=$DOMAIN
for i in $DOMAIN; do
	TOTAL=$(($TOTAL+1))
done

COUNT=$TOTAL
while [ $COUNT -gt 1 ]; do
	COUNT2=2
	while [ $COUNT2 != $COUNT -a $COUNT2 -lt $TOTAL ]; do
		domain1=$(echo $DOMAIN | cut -d ' ' -f $COUNT)
		domain2=$(echo $DOMAIN | cut -d ' ' -f $COUNT2)
		if [ $domain1 = $domain2 ]; then
			tmp=$(echo $tmp | sed 's/ '$domain1'//g' | sed 's/  / /g')
			tmp=$(echo $tmp $domain1)
		fi
		COUNT2=$(($COUNT2+1))
	done
	COUNT=$(($COUNT-1))
done
if [ "$SPECIFY_DNS" = "1" -o "$SPECIFY_DNS" = "ipv6_wan_specify_dns = 1" ]; then
	if [ "$DNS_1" != "$DNS_2" ]; then
		echo nameserver $DNS_1 > $RESOLV_IPV6
		echo nameserver $DNS_2 >> $RESOLV_IPV6
	else
		echo nameserver $DNS_1 > $RESOLV_IPV6
		nvram set ${WANPROTO}_secondary_dns=""
	fi
else
	cat $RESOLV_DHCPV6 $RESOLV_RDNSSD > $RESOLV_IPV6
	DNSLIST=$(cat $RESOLV_IPV6 | sed 's/nameserver//g' | sed '/search/d' | sed 's/ //g')
	rm -rf $RESOLV_IPV6
	is_same="true"
	COUNT=1
	COUNT2=1
	TOTAL=0
	for i in $DNSLIST; do
        	TOTAL=$((TOTAL+1))
	done
	while [ "$TOTAL" -gt "$COUNT" ]; do
        	while [ "$TOTAL" -ge "$COUNT2" ]; do
                	if [ "$COUNT2" -gt "$COUNT"  ]; then
				t1=$(echo $DNSLIST | cut -d ' ' -f $COUNT)
				t2=$(echo $DNSLIST | cut -d ' ' -f $COUNT2)
                        	if [ "$t1" = "$t2" ]; then
                                	is_same="false"
                        	fi
                	fi
			COUNT2=$((COUNT2+1))
		done
		COUNT=$((COUNT+1))
		COUNT2=$((COUNT))
		if [ "$is_same" != "false" ]; then
			echo nameserver $t1 >> $RESOLV_IPV6
		fi
        	is_same="true"
	done
	t1=$(echo $DNSLIST | cut -d ' ' -f $TOTAL)
	echo nameserver $t1 >> $RESOLV_IPV6
	sed -i '/3,$d/' $RESOLV_IPV6
fi

if [ -n "$tmp" ]; then
	echo $tmp >> $RESOLV_IPV6
fi
rm -rf $RESOLV_IPV6.tmp
cat $RESOLV_IPV6 $RESOLV_IPV4 > $RESOLV_CONF

if [ "$PRE_DNS" != "$(cat $RESOLV_IPV6)" ]; then

	killall -9 radvd
	rm /var/run/radvd.pid
	cli ipv6 dhcp6d stop
	cli ipv6 radvd start
	cli ipv6 dhcp6d start
fi
cli ipv6 route start
